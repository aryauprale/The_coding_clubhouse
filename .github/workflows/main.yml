name: Soft Warning - Utilities.md Check
on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  check-utilities:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # get full history for proper diff
      - name: Get list of changed files
        id: changed
        run: |
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD)
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      - name: Soft warning for utilities.md
        uses: actions/github-script@v7
        with:
          script: |
            const changed = process.env.CHANGED_FILES.split("\n");
            const prNumber = context.payload.pull_request.number;
            const hasInputCss = changed.some(f => f.trim() === "src/input.css");
            const hasUtilitiesMd = changed.some(f => f.trim() === "docs/utilities.md");
            if (hasInputCss && !hasUtilitiesMd) {
              const comments = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber
              });
              const existing = comments.data.find(c =>
                c.body.includes("⚠️ **Soft Warning:** input.css")
              );
              const warningText = "⚠️ **Soft Warning:** input.css was updated but docs/utilities.md was not. Please update utilities.md.";
              if (existing) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: existing.id,
                  body: warningText
                });
              } else {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  body: warningText
                });
              }
            }
        env:
          CHANGED_FILES: ${{ steps.changed.outputs.changed_files }}
